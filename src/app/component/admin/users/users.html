<div class="min-h-screen bg-teal-50 pt-8 ">
  <app-sidebar [open]="sidebarOpen()" (closeSidebar)="toggleSidebar()"></app-sidebar>

  <div class="p-6 lg:ml-[260px]">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <button
          (click)="toggleSidebar()"
          type="button"
          class="inline-flex items-center justify-center p-2 bg-teal-700 text-white rounded-md hover:bg-teal-800 lg:hidden"
        >
          <span class="material-icons text-white text-lg">menu</span>
        </button>
        <h1 class="text-2xl font-bold text-gray-800">Gestion des Utilisateurs</h1>
      </div>
    </div>

    <app-error-message [error]="error()" (retry)="loadUsers()"> </app-error-message>

    @if (loading()) {
      <div class="flex justify-center items-center py-8">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-teal-600"></div>
        <span class="ml-3 text-gray-600">Chargement...</span>
      </div>
    }

    @if (!loading()) {
      <div class="hidden lg:block">
        <app-table
          [columns]="columns"
          [data]="users()"
          [actions]="actions"
          [loading]="loading()"
          emptyMessage="Aucun utilisateur trouvé"
          (actionClick)="onTableAction($event.action, $event.item)"
        >
        </app-table>
      </div>
    }

    @if (!loading() && users().length > 0) {
      <div class="block lg:hidden space-y-3">
        @for (user of users(); track user.id) {
          <app-mobile-card
            [data]="user"
            [fields]="cardFields"
            titleField="fullName"
            [actions]="actions"
            (actionClick)="onTableAction($event.action, $event.item)"
          >
          </app-mobile-card>
        }
      </div>
    }

    @if (!loading() && users().length === 0) {
      <div class="text-center py-8 text-gray-500">Aucun utilisateur trouvé</div>
    }

    @if (showPermissionsModal()) {
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
          <!-- Header -->
          <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">
                Permissions - {{ selectedUser()?.fullName }}
              </h3>
              <p class="text-sm text-gray-600 mt-1">
                Rôle: {{ getSelectedUserRoleName() }}
              </p>
            </div>
            <button
              (click)="closePermissions()"
              class="text-gray-400 hover:text-gray-600 focus:outline-none"
            >
              <span class="material-icons">close</span>
            </button>
          </div>

          <!-- Content -->
          <div class="px-6 py-4 max-h-[calc(90vh-200px)] overflow-y-auto">
            @if (permissionError()) {
              <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                {{ permissionError() }}
              </div>
            }

            @if (selectedPermissions().length === 0) {
              <div class="text-center py-8 text-gray-500">
                <span class="material-icons text-gray-300 text-6xl mb-4">security</span>
                <p>Aucune permission assignée à cet utilisateur</p>
              </div>
            } @else {
              <div class="space-y-3">
                @for (permission of selectedPermissions(); track permission.id) {
                  <div class="border rounded-lg p-4 hover:shadow-sm transition-shadow {{ permission.active ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200' }}">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                          <span class="text-sm font-medium text-gray-500">#{{ permission.id }}</span>
                          <h5 class="font-medium text-sm text-gray-900">
                            {{ permission.permissionName }}
                          </h5>
                        </div>
                        <p class="text-xs text-gray-600">
                          {{ permission.description }}
                        </p>
                      </div>

                      <button
                        (click)="togglePermission(permission)"
                        [disabled]="permissionLoading()"
                        class="ml-3 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50"
                        [class.bg-green-500]="permission.active"
                        [class.bg-red-400]="!permission.active"
                      >
                        <span class="sr-only">Activer/Désactiver permission</span>
                        <span
                          class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                          [class.translate-x-6]="permission.active"
                          [class.translate-x-1]="!permission.active"
                        ></span>
                      </button>
                    </div>

                    <!-- Status Badge -->
                    <div class="mt-3 flex items-center justify-between">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                            [class.bg-green-100]="permission.active"
                            [class.text-green-800]="permission.active"
                            [class.bg-red-100]="!permission.active"
                            [class.text-red-800]="!permission.active">
                        @if (permission.active) {
                          <span class="material-icons text-xs mr-1">check_circle</span>
                          Actif
                        } @else {
                          <span class="material-icons text-xs mr-1">cancel</span>
                          Inactif
                        }
                      </span>

                      @if (permissionLoading()) {
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Footer -->
          <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button
              (click)="closePermissions()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    }

    <app-role-assignment
      [user]="selectedUser()"
      [show]="showRoleModal()"
      (close)="closeRoleModal()"
      (roleAssigned)="onRoleAssigned()"
    ></app-role-assignment>
  </div>
</div>
